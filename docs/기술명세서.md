# 기술 명세서 (Technical Specification)
# 인스타그램 릴스 자동 생성 프로그램

**버전:** 1.0  
**작성일:** 2025-11-22  
**상태:** Draft

---

## 목차
1. [시스템 아키텍처](#1-시스템-아키텍처)
2. [기술 스택](#2-기술-스택)
3. [데이터베이스 설계](#3-데이터베이스-설계)
4. [API 설계](#4-api-설계)
5. [모듈 구조](#5-모듈-구조)
6. [외부 서비스 연동](#6-외부-서비스-연동)
7. [보안 설계](#7-보안-설계)
8. [성능 최적화](#8-성능-최적화)
9. [배포 전략](#9-배포-전략)
10. [모니터링 및 로깅](#10-모니터링-및-로깅)

---

## 1. 시스템 아키텍처

### 1.1 전체 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                         Client Layer                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web App    │  │  Mobile App  │  │   Admin UI   │      │
│  │  (React.js)  │  │(React Native)│  │   (React)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTPS
┌───────────────────────────┴─────────────────────────────────┐
│                      API Gateway Layer                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Nginx / CloudFront CDN                  │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────┐
│                    Application Layer                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         FastAPI Backend (Python 3.11+)               │   │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐    │   │
│  │  │ Auth   │  │Content │  │ Media  │  │ Video  │    │   │
│  │  │Service │  │Service │  │Service │  │Service │    │   │
│  │  └────────┘  └────────┘  └────────┘  └────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────┐
│                      Task Queue Layer                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Celery Workers + Redis Queue                        │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│  │  │ Render   │  │Download  │  │  TTS     │           │   │
│  │  │ Worker   │  │ Worker   │  │ Worker   │           │   │
│  │  └──────────┘  └──────────┘  └──────────┘           │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────┐
│                     Data Layer                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  PostgreSQL  │  │    Redis     │  │   AWS S3     │      │
│  │  (Primary DB)│  │   (Cache)    │  │ (File Store) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────┐
│                  External Services                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ OpenAI   │ │ElevenLabs│ │ Unsplash │ │  Pexels  │       │
│  │   API    │ │   API    │ │   API    │ │   API    │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 데이터 흐름

```
사용자 키워드 입력
    ↓
[API Gateway] 요청 검증 및 인증
    ↓
[Content Service] GPT API 호출 → 대본 생성
    ↓
[Media Service] 이미지 API 호출 → 이미지 수집 및 다운로드
    ↓
[TTS Worker] TTS API 호출 → 음성 파일 생성
    ↓
[Render Worker] MoviePy → 영상 합성 및 렌더링
    ↓
[S3] 최종 영상 업로드
    ↓
[API] 사용자에게 다운로드 URL 반환
```

---

## 2. 기술 스택

### 2.1 백엔드

| 카테고리 | 기술 | 버전 | 용도 |
|---------|------|------|------|
| **언어** | Python | 3.11+ | 주 개발 언어 |
| **웹 프레임워크** | FastAPI | 0.104+ | REST API 서버 |
| **비동기 처리** | asyncio, httpx | - | 비동기 I/O |
| **작업 큐** | Celery | 5.3+ | 백그라운드 작업 |
| **메시지 브로커** | Redis | 7.0+ | Celery 브로커, 캐싱 |
| **ORM** | SQLAlchemy | 2.0+ | 데이터베이스 ORM |
| **마이그레이션** | Alembic | 1.12+ | DB 스키마 관리 |
| **검증** | Pydantic | 2.0+ | 데이터 검증 |
| **인증** | python-jose, passlib | - | JWT 토큰 |

### 2.2 프론트엔드

| 카테고리 | 기술 | 버전 | 용도 |
|---------|------|------|------|
| **프레임워크** | React | 18+ | UI 라이브러리 |
| **언어** | TypeScript | 5.0+ | 타입 안정성 |
| **상태 관리** | Zustand | 4.0+ | 전역 상태 관리 |
| **라우팅** | React Router | 6.0+ | 클라이언트 라우팅 |
| **스타일링** | Tailwind CSS | 3.0+ | 유틸리티 CSS |
| **HTTP 클라이언트** | Axios | 1.6+ | API 통신 |
| **폼 관리** | React Hook Form | 7.0+ | 폼 상태 관리 |
| **빌드 도구** | Vite | 5.0+ | 빌드 및 번들링 |

### 2.3 영상 처리

| 카테고리 | 기술 | 버전 | 용도 |
|---------|------|------|------|
| **영상 편집** | MoviePy | 1.0.3+ | 파이썬 영상 편집 |
| **인코딩** | FFmpeg | 6.0+ | 영상 인코딩/변환 |
| **이미지 처리** | Pillow (PIL) | 10.0+ | 이미지 조작 |
| **컴퓨터 비전** | OpenCV | 4.8+ | 고급 영상 처리 |

### 2.4 인프라

| 카테고리 | 기술 | 용도 |
|---------|------|------|
| **클라우드** | AWS | 전체 인프라 |
| **컴퓨팅** | EC2 (t3.large) | 애플리케이션 서버 |
| **GPU 인스턴스** | EC2 (g4dn.xlarge) | 영상 렌더링 |
| **스토리지** | S3 | 파일 저장 |
| **CDN** | CloudFront | 콘텐츠 배포 |
| **데이터베이스** | RDS (PostgreSQL) | 관리형 DB |
| **캐시** | ElastiCache (Redis) | 관리형 Redis |
| **로드 밸런서** | ALB | 부하 분산 |
| **컨테이너** | Docker | 애플리케이션 컨테이너화 |
| **오케스트레이션** | Docker Compose | 로컬 개발 환경 |

### 2.5 DevOps 및 모니터링

| 카테고리 | 기술 | 용도 |
|---------|------|------|
| **CI/CD** | GitHub Actions | 자동 배포 |
| **로깅** | CloudWatch Logs | 중앙 로그 수집 |
| **에러 추적** | Sentry | 에러 모니터링 |
| **APM** | New Relic / DataDog | 성능 모니터링 |
| **업타임 모니터링** | UptimeRobot | 서비스 가용성 |

### 2.6 외부 API

| 서비스 | 용도 | 요금 |
|--------|------|------|
| **OpenAI GPT-4** | 대본 생성 | $0.03/1K tokens |
| **ElevenLabs** | TTS 음성 생성 | $0.30/1K chars |
| **Unsplash API** | 이미지 검색 | 무료 (50 req/hr) |
| **Pexels API** | 영상 검색 | 무료 (200 req/hr) |
| **Stripe** | 결제 처리 | 2.9% + $0.30 |

---

## 3. 데이터베이스 설계

### 3.1 ERD (Entity Relationship Diagram)

```
┌─────────────────┐       ┌─────────────────┐
│     users       │───┐   │   projects      │
├─────────────────┤   │   ├─────────────────┤
│ id (PK)         │   └──<│ id (PK)         │
│ email           │       │ user_id (FK)    │
│ password_hash   │       │ keyword         │
│ name            │       │ script          │
│ created_at      │       │ status          │
│ subscription    │   ┌──>│ video_url       │
│ api_quota       │   │   │ created_at      │
└─────────────────┘   │   └─────────────────┘
                      │
                      │   ┌─────────────────┐
                      └───│  media_assets   │
                          ├─────────────────┤
                          │ id (PK)         │
                          │ project_id (FK) │
                          │ type            │
                          │ url             │
                          │ source          │
                          │ order           │
                          └─────────────────┘
```

### 3.2 테이블 스키마

#### 3.2.1 users (사용자)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    subscription_plan VARCHAR(50) DEFAULT 'free',
    api_quota INTEGER DEFAULT 10,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    email_verified BOOLEAN DEFAULT FALSE,
    
    INDEX idx_email (email),
    INDEX idx_subscription (subscription_plan)
);
```

#### 3.2.2 projects (프로젝트/영상)

```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    keyword VARCHAR(500) NOT NULL,
    script TEXT,
    status VARCHAR(50) DEFAULT 'pending', -- pending, processing, completed, failed
    video_url TEXT,
    thumbnail_url TEXT,
    duration INTEGER, -- 영상 길이 (초)
    settings JSONB, -- 영상 설정 (음성, 스타일 등)
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

#### 3.2.3 media_assets (미디어 에셋)

```sql
CREATE TABLE media_assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL, -- image, video, audio
    url TEXT NOT NULL,
    source VARCHAR(100), -- unsplash, pexels, user_upload
    order_index INTEGER,
    metadata JSONB, -- 원본 해상도, 라이선스 정보 등
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_project_id (project_id),
    INDEX idx_type (type)
);
```

#### 3.2.4 hashtags (해시태그)

```sql
CREATE TABLE hashtags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    tag VARCHAR(100) NOT NULL,
    
    INDEX idx_project_id (project_id),
    INDEX idx_tag (tag)
);
```

#### 3.2.5 api_usage (API 사용량 추적)

```sql
CREATE TABLE api_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    service VARCHAR(50) NOT NULL, -- openai, elevenlabs, etc.
    endpoint VARCHAR(200),
    tokens_used INTEGER,
    cost DECIMAL(10, 4),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_service (service),
    INDEX idx_created_at (created_at)
);
```

#### 3.2.6 subscriptions (구독 정보)

```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    plan VARCHAR(50) NOT NULL, -- free, basic, pro, enterprise
    status VARCHAR(50) DEFAULT 'active', -- active, canceled, expired
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    current_period_start TIMESTAMP,
    current_period_end TIMESTAMP,
    cancel_at_period_end BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);
```

### 3.3 인덱스 전략
- 자주 검색되는 컬럼 (user_id, status, created_at)에 인덱스 생성
- UUID 기본키 사용으로 분산 확장성 확보
- JSONB 타입으로 유연한 메타데이터 저장

---

## 4. API 설계

### 4.1 API 개요
- **Base URL**: `https://api.reelmaker.ai/v1`
- **인증**: JWT Bearer Token
- **응답 포맷**: JSON
- **에러 코드**: HTTP 표준 상태 코드

### 4.2 인증 API

#### POST /auth/register
회원가입

**Request**:
```json
{
  "email": "user@example.com",
  "password": "securePassword123!",
  "name": "홍길동"
}
```

**Response** (201):
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "홍길동",
  "token": "jwt.token.here"
}
```

#### POST /auth/login
로그인

**Request**:
```json
{
  "email": "user@example.com",
  "password": "securePassword123!"
}
```

**Response** (200):
```json
{
  "token": "jwt.token.here",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "홍길동",
    "subscription_plan": "free"
  }
}
```

### 4.3 프로젝트 API

#### POST /projects
새 릴스 프로젝트 생성

**Request**:
```json
{
  "keyword": "AI 트렌드 2025",
  "settings": {
    "duration": 30,
    "voice": "female_bright",
    "style": "modern",
    "language": "ko"
  }
}
```

**Response** (202):
```json
{
  "project_id": "uuid",
  "status": "pending",
  "message": "영상 생성이 시작되었습니다."
}
```

#### GET /projects/{project_id}
프로젝트 상태 조회

**Response** (200):
```json
{
  "id": "uuid",
  "keyword": "AI 트렌드 2025",
  "status": "completed",
  "video_url": "https://cdn.reelmaker.ai/videos/xxx.mp4",
  "thumbnail_url": "https://cdn.reelmaker.ai/thumbnails/xxx.jpg",
  "duration": 30,
  "script": "대본 내용...",
  "hashtags": ["#AI", "#트렌드", "#2025"],
  "created_at": "2025-11-22T10:00:00Z",
  "completed_at": "2025-11-22T10:03:24Z"
}
```

#### GET /projects
사용자의 모든 프로젝트 조회

**Query Parameters**:
- `page`: 페이지 번호 (기본값: 1)
- `limit`: 페이지당 개수 (기본값: 20)
- `status`: 필터 (pending, processing, completed, failed)

**Response** (200):
```json
{
  "total": 45,
  "page": 1,
  "limit": 20,
  "projects": [
    {
      "id": "uuid",
      "keyword": "AI 트렌드",
      "status": "completed",
      "thumbnail_url": "...",
      "created_at": "2025-11-22T10:00:00Z"
    }
  ]
}
```

#### DELETE /projects/{project_id}
프로젝트 삭제

**Response** (204):
```
No Content
```

### 4.4 미디어 API

#### GET /media/search
이미지/영상 검색 (프리뷰용)

**Query Parameters**:
- `query`: 검색 키워드
- `type`: image | video
- `source`: unsplash | pexels | all

**Response** (200):
```json
{
  "results": [
    {
      "id": "xxx",
      "url": "https://...",
      "thumbnail_url": "https://...",
      "source": "unsplash",
      "width": 1920,
      "height": 1080,
      "author": "Photographer Name"
    }
  ]
}
```

### 4.5 사용자 API

#### GET /users/me
현재 사용자 정보

**Response** (200):
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "홍길동",
  "subscription_plan": "pro",
  "api_quota": 50,
  "created_at": "2025-01-01T00:00:00Z"
}
```

#### PATCH /users/me
사용자 정보 수정

**Request**:
```json
{
  "name": "새 이름"
}
```

**Response** (200):
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "새 이름"
}
```

### 4.6 에러 응답 포맷

```json
{
  "error": {
    "code": "INVALID_REQUEST",
    "message": "키워드는 필수입니다.",
    "details": {
      "field": "keyword",
      "reason": "Missing required field"
    }
  }
}
```

**에러 코드**:
- `INVALID_REQUEST`: 잘못된 요청
- `UNAUTHORIZED`: 인증 실패
- `FORBIDDEN`: 권한 없음
- `NOT_FOUND`: 리소스 없음
- `RATE_LIMIT_EXCEEDED`: 요청 제한 초과
- `QUOTA_EXCEEDED`: 할당량 초과
- `INTERNAL_ERROR`: 서버 에러
- `EXTERNAL_API_ERROR`: 외부 API 에러

---

## 5. 모듈 구조

### 5.1 디렉토리 구조

```
macro/
├── src/
│   ├── api/                    # API 라우터
│   │   ├── __init__.py
│   │   ├── auth.py            # 인증 API
│   │   ├── projects.py        # 프로젝트 API
│   │   ├── media.py           # 미디어 API
│   │   └── users.py           # 사용자 API
│   │
│   ├── core/                   # 핵심 설정
│   │   ├── __init__.py
│   │   ├── config.py          # 환경 설정
│   │   ├── security.py        # 보안 (JWT, 암호화)
│   │   └── database.py        # DB 연결
│   │
│   ├── models/                 # DB 모델
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── project.py
│   │   └── media.py
│   │
│   ├── schemas/                # Pydantic 스키마
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── project.py
│   │   └── media.py
│   │
│   ├── services/               # 비즈니스 로직
│   │   ├── __init__.py
│   │   ├── content_service.py  # 대본 생성
│   │   ├── media_service.py    # 이미지/영상 수집
│   │   ├── tts_service.py      # 음성 생성
│   │   └── video_service.py    # 영상 합성
│   │
│   ├── workers/                # Celery workers
│   │   ├── __init__.py
│   │   ├── video_render.py    # 영상 렌더링 작업
│   │   ├── media_download.py  # 미디어 다운로드 작업
│   │   └── tts_generate.py    # TTS 생성 작업
│   │
│   ├── integrations/           # 외부 API 통합
│   │   ├── __init__.py
│   │   ├── openai_client.py   # OpenAI API
│   │   ├── elevenlabs_client.py # ElevenLabs API
│   │   ├── unsplash_client.py  # Unsplash API
│   │   └── pexels_client.py    # Pexels API
│   │
│   ├── utils/                  # 유틸리티
│   │   ├── __init__.py
│   │   ├── file_utils.py      # 파일 처리
│   │   ├── video_utils.py     # 영상 처리 헬퍼
│   │   └── logger.py          # 로깅 설정
│   │
│   └── main.py                 # FastAPI 앱 진입점
│
├── tests/                      # 테스트
│   ├── unit/
│   ├── integration/
│   └── e2e/
│
├── scripts/                    # 유틸리티 스크립트
│   ├── setup_db.py            # DB 초기화
│   └── seed_data.py           # 테스트 데이터
│
├── migrations/                 # Alembic 마이그레이션
│   └── versions/
│
├── config/                     # 설정 파일
│   ├── development.env
│   ├── production.env
│   └── test.env
│
├── docker/                     # Docker 관련
│   ├── Dockerfile
│   ├── docker-compose.yml
│   └── docker-compose.prod.yml
│
├── docs/                       # 문서
│   ├── PRD.md
│   ├── 기술명세서.md
│   └── API명세서.md
│
├── .cursorrules               # Cursor AI 규칙
├── .gitignore
├── requirements.txt
├── requirements-dev.txt
├── pyproject.toml
└── README.md
```

### 5.2 핵심 모듈 설명

#### 5.2.1 Content Service (대본 생성)

```python
# src/services/content_service.py

from typing import Dict, Any
from openai import AsyncOpenAI
from src.core.config import settings

class ContentService:
    """
    GPT를 활용한 릴스 대본 생성 서비스
    """
    
    def __init__(self):
        self.client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
    
    async def generate_script(
        self, 
        keyword: str, 
        duration: int = 30,
        style: str = "modern"
    ) -> Dict[str, Any]:
        """
        키워드를 기반으로 릴스 대본을 생성합니다.
        
        Args:
            keyword: 검색 키워드
            duration: 영상 길이 (초)
            style: 스타일 (modern, news, educational)
        
        Returns:
            대본 및 메타데이터를 포함한 딕셔너리
        """
        prompt = self._build_prompt(keyword, duration, style)
        
        response = await self.client.chat.completions.create(
            model="gpt-4-turbo-preview",
            messages=[
                {"role": "system", "content": "당신은 바이럴 릴스 대본 작가입니다."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=500
        )
        
        script = response.choices[0].message.content
        
        return {
            "script": script,
            "scenes": self._parse_scenes(script),
            "estimated_duration": duration,
            "tokens_used": response.usage.total_tokens
        }
    
    def _build_prompt(self, keyword: str, duration: int, style: str) -> str:
        """프롬프트 생성"""
        return f"""
        다음 키워드로 {duration}초 분량의 인스타그램 릴스 대본을 작성해주세요.
        키워드: {keyword}
        스타일: {style}
        
        구조:
        1. 훅 (첫 3초): 시선을 사로잡는 문구
        2. 본문: 핵심 내용 전달
        3. 클로징: CTA 및 마무리
        
        각 장면마다 필요한 이미지 키워드도 함께 제시해주세요.
        """
    
    def _parse_scenes(self, script: str) -> list:
        """대본을 장면별로 파싱"""
        # 구현...
        pass
```

#### 5.2.2 Video Service (영상 합성)

```python
# src/services/video_service.py

from typing import List
from moviepy.editor import *
from PIL import Image
import numpy as np

class VideoService:
    """
    MoviePy를 활용한 영상 합성 서비스
    """
    
    def __init__(self):
        self.width = 1080
        self.height = 1920
        self.fps = 30
    
    async def create_video(
        self,
        images: List[str],
        audio_path: str,
        subtitles: List[dict],
        output_path: str
    ) -> str:
        """
        이미지, 음성, 자막을 합쳐 최종 영상을 생성합니다.
        
        Args:
            images: 이미지 파일 경로 리스트
            audio_path: 음성 파일 경로
            subtitles: 자막 정보 리스트
            output_path: 출력 파일 경로
        
        Returns:
            생성된 영상 파일 경로
        """
        # 음성 파일 로드
        audio = AudioFileClip(audio_path)
        duration = audio.duration
        
        # 이미지 클립 생성
        image_clips = self._create_image_clips(images, duration)
        
        # 자막 클립 생성
        subtitle_clips = self._create_subtitle_clips(subtitles)
        
        # 모든 클립 합성
        final_clip = CompositeVideoClip(image_clips + subtitle_clips)
        final_clip = final_clip.set_audio(audio)
        final_clip = final_clip.set_duration(duration)
        
        # 렌더링
        final_clip.write_videofile(
            output_path,
            fps=self.fps,
            codec='libx264',
            audio_codec='aac',
            bitrate='5000k',
            preset='medium',
            threads=4
        )
        
        return output_path
    
    def _create_image_clips(self, images: List[str], duration: float) -> List:
        """이미지 클립 생성 (Ken Burns 효과 포함)"""
        clips = []
        time_per_image = duration / len(images)
        
        for i, img_path in enumerate(images):
            start_time = i * time_per_image
            
            # 이미지 리사이즈
            clip = ImageClip(img_path, duration=time_per_image)
            clip = clip.resize((self.width, self.height))
            
            # Ken Burns 효과 (줌인)
            clip = clip.resize(lambda t: 1 + 0.1 * t / time_per_image)
            
            clip = clip.set_start(start_time)
            clips.append(clip)
        
        return clips
    
    def _create_subtitle_clips(self, subtitles: List[dict]) -> List:
        """자막 클립 생성"""
        clips = []
        
        for sub in subtitles:
            txt_clip = TextClip(
                sub['text'],
                fontsize=60,
                color='white',
                font='Pretendard-Bold',
                stroke_color='black',
                stroke_width=2,
                method='caption',
                size=(self.width - 100, None)
            )
            
            txt_clip = txt_clip.set_position(('center', 'bottom'))
            txt_clip = txt_clip.set_start(sub['start'])
            txt_clip = txt_clip.set_duration(sub['duration'])
            
            clips.append(txt_clip)
        
        return clips
```

---

## 6. 외부 서비스 연동

### 6.1 OpenAI GPT-4 연동

**용도**: 대본 생성  
**인증**: API Key (Bearer Token)  
**Rate Limit**: 10,000 RPM  

**구현 예시**:
```python
from openai import AsyncOpenAI

client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)

async def generate_script(keyword: str) -> str:
    response = await client.chat.completions.create(
        model="gpt-4-turbo-preview",
        messages=[
            {"role": "system", "content": "대본 작가"},
            {"role": "user", "content": f"키워드: {keyword}"}
        ]
    )
    return response.choices[0].message.content
```

### 6.2 ElevenLabs TTS 연동

**용도**: 음성 생성  
**인증**: API Key (Header: xi-api-key)  
**Rate Limit**: 프리티어 10,000 chars/month  

**구현 예시**:
```python
import httpx

async def generate_voice(text: str, voice_id: str) -> bytes:
    url = f"https://api.elevenlabs.io/v1/text-to-speech/{voice_id}"
    headers = {"xi-api-key": settings.ELEVENLABS_API_KEY}
    
    async with httpx.AsyncClient() as client:
        response = await client.post(
            url,
            json={"text": text, "model_id": "eleven_multilingual_v2"},
            headers=headers
        )
        return response.content
```

### 6.3 Unsplash API 연동

**용도**: 이미지 검색  
**인증**: Access Key (Query Param)  
**Rate Limit**: 50 requests/hour (프리티어)  

**구현 예시**:
```python
async def search_images(query: str, count: int = 5) -> list:
    url = "https://api.unsplash.com/search/photos"
    params = {
        "query": query,
        "per_page": count,
        "client_id": settings.UNSPLASH_ACCESS_KEY
    }
    
    async with httpx.AsyncClient() as client:
        response = await client.get(url, params=params)
        data = response.json()
        return [
            {
                "url": photo["urls"]["regular"],
                "author": photo["user"]["name"],
                "download_location": photo["links"]["download_location"]
            }
            for photo in data["results"]
        ]
```

---

## 7. 보안 설계

### 7.1 인증 및 권한

#### JWT 토큰 구조
```json
{
  "sub": "user_id",
  "email": "user@example.com",
  "exp": 1735200000,
  "iat": 1735113600,
  "subscription": "pro"
}
```

#### 비밀번호 해싱
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)
```

### 7.2 API 보안

#### Rate Limiting
```python
from fastapi_limiter import FastAPILimiter
from fastapi_limiter.depends import RateLimiter

@app.post("/projects", dependencies=[Depends(RateLimiter(times=10, hours=1))])
async def create_project(...):
    pass
```

#### CORS 설정
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://reelmaker.ai"],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)
```

### 7.3 데이터 보안

- **전송 중 암호화**: HTTPS/TLS 1.3
- **저장 시 암호화**: S3 AES-256 암호화
- **민감 정보**: 환경 변수로 관리
- **DB 접근**: IAM 역할 기반 인증

---

## 8. 성능 최적화

### 8.1 캐싱 전략

#### Redis 캐시 사용
```python
import redis.asyncio as redis

cache = redis.from_url("redis://localhost")

async def get_cached_images(keyword: str):
    cache_key = f"images:{keyword}"
    cached = await cache.get(cache_key)
    
    if cached:
        return json.loads(cached)
    
    # API 호출
    images = await fetch_images(keyword)
    await cache.setex(cache_key, 3600, json.dumps(images))
    return images
```

### 8.2 비동기 처리

#### Celery 작업 큐
```python
from celery import Celery

celery_app = Celery('tasks', broker='redis://localhost:6379/0')

@celery_app.task
def render_video_task(project_id: str):
    """백그라운드 영상 렌더링"""
    # 렌더링 로직
    pass

# API에서 호출
render_video_task.delay(project_id)
```

### 8.3 데이터베이스 최적화

- **Connection Pooling**: SQLAlchemy pool_size=20
- **인덱스**: 자주 조회되는 컬럼에 인덱스 생성
- **N+1 쿼리 방지**: `joinedload()` 사용
- **읽기 전용 replica**: 조회용 DB 분리

---

## 9. 배포 전략

### 9.1 Docker 컨테이너화

```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# FFmpeg 설치
RUN apt-get update && apt-get install -y ffmpeg

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 9.2 CI/CD 파이프라인

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run tests
        run: pytest
      
      - name: Build Docker image
        run: docker build -t reelmaker-api .
      
      - name: Push to ECR
        run: |
          aws ecr get-login-password | docker login --username AWS --password-stdin
          docker push reelmaker-api:latest
      
      - name: Deploy to ECS
        run: |
          aws ecs update-service --cluster prod --service api --force-new-deployment
```

---

## 10. 모니터링 및 로깅

### 10.1 로깅 설정

```python
import logging
from pythonjsonlogger import jsonlogger

logger = logging.getLogger()

logHandler = logging.StreamHandler()
formatter = jsonlogger.JsonFormatter()
logHandler.setFormatter(formatter)
logger.addHandler(logHandler)
logger.setLevel(logging.INFO)

logger.info("Video rendering started", extra={
    "project_id": project_id,
    "user_id": user_id
})
```

### 10.2 메트릭 수집

- **API 응답 시간**: CloudWatch Metrics
- **렌더링 시간**: Custom Metrics
- **에러율**: Sentry
- **사용자 활동**: Mixpanel/Amplitude

---

**문서 작성자**: Engineering Team  
**최종 수정일**: 2025-11-22

